# Tsilies Worker API

This is the API used by tsilies workers to upload new data to the tsilies controller.

## Add New Worker
To add a new worker you first have to define a unique id `worker_uid` that will be used by the worker to identify itself. This `worker_uid` is randomly generated when you start the worker process for the first time. After you have added the new worker via the administration interface the worker service makes an API call to make itself known to the tsilies controller. 

To do that it makes the following API call: 

 - Endpoint: `/api/worker/adopt`
 - HTTP Request Method: `POST`
 - Header: `Accept: application/json`

With the following parameters:

```json
{
    "worker_uid": "<32 bit string>"
}
```

### Successful Adoption
If the worker_uid existed on the system the controller will respond with the following information:

 - 200 OK

```json
{
    "status": "ok",
    "worker_uid": "<32 bit string>"
}
```

### Unsuccessful Adoption
If the worker_uid did not exis in the system either because it was typed incorrectly or the user hadn't added it the controller will respond with the following information.

 - 404 Not Found

```json
{
    "status": "not_found",
    "worker_uid": "<32 bit string>"
}
```

## Check Adoption Status

The new worker appears on the administration panel where the user should click "Adopt" to add it to the system.

The worker waits to get adopted by periodically (every 10 seconds) checking it's adoption status. 
To do that, it makes the following API call:

 - Endpoint: `/api/worker/adopt_status`
 - HTTP Request Method: `GET`
  
With the following parameters:

```http
    worker_uid: <32 bit string>
```

### Approved Adoption

If the worker was approved by the user the controller will respond with the following data:

 - 200 OK

```json
{
    "status": "ok",
    "worker_uid": "<32 bit string>",
    "secret": "string"
}
```
The `secret` string is the "password" in a way that will be used by the worker when requesting an API token. The secret string is stored in a file so it can be re-used during the token renewal process.

### Unapproved Adoption

If the worker was not approved by the user or the worker_uid was mistyped, the controller will respond with the following data:

 - 404 Not Found

```json
{
    "status": "unadopted",
    "worker_uid": "<32 bit string>"
}
```

## Request API token

After the worker was approved it has to request a new API token to be able to make API calls and submit data to the controller. To do that it makes the following request:

 - Endpoint: `/api/worker/token`
 - HTTP Request Method `POST`
 - Header: `Accept: application/json`

```json
{
    "worker_uid": "<32 bit string>",
    "secret": "<String provided while checking for the adoption status>"
}
```
### Successful call:
If the data provided by the worker was correct the controller will respond with a new API token to be used by the worker.

 - 200 OK

```json
{
    "status": "authorised",
    "token": "<long hexadecimal string to-be-defined>",
    "worker_uid": "<32 bit string>",
    "expires_in": "604800"
}
```
`expires_in` defines the amount of time before the token is invalid and the worker will have to go through the process of generating a new token.

The `token` value is generated by the following operation: 

`SHA256($worker_uid+$timestamp+$randomseed)`


### Failed to authenticate

If the `secret` or the `worker_uid` parameter are invalid the controller will respond with the following information:

 - 403 Forbidden

```json
{
    "status":"failed_to_authenticate",
}
```
## Renewing an API token
After the `expires_in` time has passed the token will have expired and the worker will have to request a new token.

To request a new token, the worker has to go through the token generation process again. It uses the `secret` string stored in a file at the system it's running on. 

## Get job information

The worker periodically (every hour) checks for new jobs (hosts to ping and report status for every `interval` seconds) by making the following API call:

 - Endpoint: `/api/worker/new_jobs`
 - HTTP Request Method: `GET`
 - HTTP Header: `Token: <Random hexadecimal string>`
  
  Using the following Parameters:

  ```http
    worker_uid: <32 bit string>
  ```
### Valid Data

If the information submitted by the worker, the controller responds with the following information. 

 - 200 OK

If there are pending jobs:

```json
{
    "worker_uid": "<32 bit string>",
    "pending-jobs": "number of hosts to ping",
    "status": "ok",
    "hosts": [
        {
            "id": "1a2b3c",
            "ip": "x.y.z.w",
            "interval": "60",
        },
        {
            "id": "4d5e6f",
            "ip": "a.b.c.d",
            "interval": "120"
        }
    ]
}
```

If there are no pending jobs:

```json
{
    "worker_uid": "<32 bit string>",
    "pending_jobs": "0",
    "hosts": "none",
    "status": "ok"
}
```

### Failed to authenticate

If the `Token` header or the `worker_uid` parameter are invalid the controller will respond with the following information:

 - 403 Forbidden

```json
{
    "status":"failed_to_authenticate",
}
```

### Invalid Data

If the data provided by the worker are invalid the controller will respond with the following information:

 - 403 Unauthorised
  
```json
{
    "worker_uid": "<32 bit string>",
    "status": "invalid_data"
}
```

## Submit data

After the worker has retrieved the status of the hosts it has to upload the data to the controller for further processing. To do that it makes the following request:

 - Endpoint: `/api/worker/submit_data`
 - HTTP Request Method: `POST`
 - Header: `Token: <random hexadecimal string>`
 - Header: `Accept: application/json`
  
And pass the following information:

```json
{
    "worker_uid":"<32 bit string>",
    "host_id":"1a2b3c",
    "host_status":"{active,inactive}",
    "host_latency":"<rtt time in milliseconds>",
    "status":"ok"
}
```

### Valid data

If the data provided by the worker were valid and no required parameter was missing the controller will respond with the following information.

 - 200 OK

```json
{
    "worker_uid":"<32 bit string>",
    "status":"ok"
}
```

### Failed to authenticate

If the `Token` header or the `worker_uid` parameter are invalid the controller will respond with the following information:

 - 403 Forbidden

```json
{
    "status":"failed_to_authenticate",
}
```

### Invalid data

If the data provided by the worker were invalid the controller will respond with the following information

 - 404 Not Found

```json
{
    "worker_uid":"<32 bit string>",
    "status":"invalid_data",
}
```

## Periodic Health Update

The workers periodically inform the controller that they are still active by hitting a `heartbeat` endpoint. To do that they make the following request:

 - Endpoint: `/api/worker/heartbeat`
 - HTTP Request Method: `GET`
 - Header: `Token: <random hexadecimal string>`

And using the following parameters:

```http
worker_uid: <32 bit string>
```

### Valid data

If the data provided by the worker were valid the controller will respond with the following information:

 - 200 OK
  
```json
{
    "worker_uid": "<32 bit string>",
    "status": "ok"
}
```

### Failed to authenticate

If the `Token` header or the `worker_uid` parameter are invalid the controller will respond with the following information:

 - 403 Forbidden

```json
{
    "status":"failed_to_authenticate",
}
```

### Invalid data

If the data provided by the worker were invalid the controller will respond with the following information:

 - 403 Forbidden

```json
{
    "worker_uid": "<32 bit string>",
    "status": "invalid_data
}
```

